name: AI Agent - Issue Creation (Copilot Workspace)

on:
  repository_dispatch:
    types: [assign-to-ai]

permissions:
  issues: write
  contents: read

jobs:
  create-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueKey = context.payload.client_payload.issue_key;
            const summary = context.payload.client_payload.summary;
            
            // Fetch Jira issue details
            const jiraResponse = await fetch(
              `https://${process.env.JIRA_DOMAIN}/rest/api/3/issue/${issueKey}`,
              {
                headers: {
                  'Authorization': `Basic ${Buffer.from(`${process.env.JIRA_EMAIL}:${process.env.JIRA_API_TOKEN}`).toString('base64')}`,
                  'Accept': 'application/json'
                }
              }
            );
            
            const jiraIssue = await jiraResponse.json();
            const description = jiraIssue.fields.description;
            
            // Extract text from Atlassian Document Format
            let descriptionText = '';
            if (description && description.content) {
              const extractText = (node) => {
                let text = '';
                if (node.text) text += node.text;
                if (node.content) {
                  node.content.forEach(child => {
                    text += extractText(child);
                  });
                }
                return text;
              };
              descriptionText = extractText(description);
            }
            
            // Create GitHub Issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${issueKey}: ${summary}`,
              body: `## AI Task from Jira

**Jira Issue:** [${issueKey}](https://${process.env.JIRA_DOMAIN}/browse/${issueKey})

**Description:**
${descriptionText || summary}

---

### Instructions:
1. Click "Open in Copilot Workspace" (if available)
2. Review the AI-generated changes
3. Commit and create a PR

**Note:** This issue was automatically created from Jira.`,
              labels: ['ai-task', 'jira-sync']
            });
            
            console.log(`Created issue: ${issue.data.html_url}`);
            
            // Comment on Jira ticket
            await fetch(
              `https://${process.env.JIRA_DOMAIN}/rest/api/3/issue/${issueKey}/comment`,
              {
                method: 'POST',
                headers: {
                  'Authorization': `Basic ${Buffer.from(`${process.env.JIRA_EMAIL}:${process.env.JIRA_API_TOKEN}`).toString('base64')}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  body: {
                    type: 'doc',
                    version: 1,
                    content: [{
                      type: 'paragraph',
                      content: [{
                        type: 'text',
                        text: `GitHub Issue created: ${issue.data.html_url}`
                      }]
                    }]
                  }
                })
              }
            );
        env:
          JIRA_DOMAIN: ${{ secrets.JIRA_DOMAIN }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
